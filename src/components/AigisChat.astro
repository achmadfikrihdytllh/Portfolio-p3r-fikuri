---
// src/components/AigisChat.astro
---
<div class="fixed bottom-6 left-6 z-[100] font-['Exo_2']">
  <button id="aigis-toggle" class="relative w-16 h-16 rounded-full border-2 border-cyan-400 bg-[#001030] flex items-center justify-center group shadow-[0_0_25px_rgba(0,240,255,0.6)] hover:scale-110 transition-all active:scale-95">
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400 group-hover:rotate-12 transition-transform">
      <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/>
    </svg>
    <div class="absolute inset-0 bg-cyan-500/10 animate-pulse pointer-events-none rounded-full"></div>
  </button>

  <div id="aigis-window" class="absolute bottom-24 left-0 w-[360px] bg-[#00081a]/95 backdrop-blur-xl border-2 border-cyan-500/40 rounded-sm opacity-0 pointer-events-none transition-all duration-300 translate-y-5 shadow-[0_0_60px_rgba(0,0,0,1)] overflow-hidden">
    
    <div class="bg-cyan-400 text-black px-4 py-2 -skew-x-12 border-l-4 border-white mb-1 flex justify-between items-center shadow-lg transform -translate-x-2">
      <span class="font-black italic tracking-tighter text-[11px] skew-x-12 uppercase">Aigis_Personnel_Compendium</span>
      <button id="close-chat" class="text-[10px] font-black hover:bg-black hover:text-cyan-400 px-2 transition-colors skew-x-12">CLOSE</button>
    </div>

    <div id="chat-display" class="h-[420px] overflow-y-auto space-y-6 p-4 scrollbar-none flex flex-col relative bg-[linear-gradient(rgba(0,240,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(0,240,255,0.03)_1px,transparent_1px)] bg-[size:25px_25px]">
      <div class="flex items-start gap-3 self-start animate-fade-in">
        <div class="shrink-0">
          <img id="aigis-current-avatar" src="/aigis-portrait.png" class="w-12 h-12 border-2 border-cyan-400 -skew-x-6 bg-cyan-900 object-cover shadow-[4px_4px_0_rgba(0,240,255,0.3)]" />
        </div>
        <div class="bg-[#001030] text-white p-3 -skew-x-6 border-r-4 border-cyan-500 max-w-[240px] shadow-lg border border-cyan-500/20">
          <p class="skew-x-6 text-[11px] leading-relaxed font-medium">Sistem siap. Menunggu instruksi strategis dari Leader.</p>
        </div>
      </div>
    </div>

    <div class="p-3 bg-cyan-900/20 border-t border-cyan-500/30 flex gap-2">
      <div class="flex-1 -skew-x-12 overflow-hidden shadow-inner">
        <input type="text" id="user-input" placeholder="Enter instruction..." class="w-full bg-white text-black p-2.5 border-none focus:ring-0 font-bold text-[11px] placeholder:text-gray-400" />
      </div>
      <button id="send-btn" class="bg-cyan-400 text-black px-5 font-black hover:bg-white transition-all -skew-x-12 text-[11px] shadow-[3px_3px_0_rgba(255,255,255,0.3)] active:shadow-none active:translate-x-1 active:translate-y-1">SEND</button>
    </div>
  </div>
</div>

<script>
  // Logic Avatar Berdasarkan Waktu
  function getAigisAvatar() {
    const now = new Date();
    const day = now.getDay(); // 0=Minggu, 6=Sabtu
    const hour = now.getHours();

    // Hari ini Rabu (day=3), jam 15 (jam kerja)
    if (day === 6) return '/aigis-weekend2.png'; 
    if (day === 0) return '/aigis-weekend.png';
    
    // Jam Kerja: Senin-Jumat 08:00 - 17:00
    // Perhatikan: Aigis-uniform.png diawali 'A' Besar sesuai daftar filemu
    if (day >= 1 && day <= 5 && hour >= 8 && hour < 17) {
      return '/Aigis-uniform.png'; 
    }

    return '/aigis-portrait.png'; 
  }

  const currentAvatar = document.getElementById('aigis-current-avatar') as HTMLImageElement;
  if (currentAvatar) currentAvatar.src = getAigisAvatar();

  const display = document.getElementById('chat-display');
  const input = document.getElementById('user-input') as HTMLInputElement;
  const sendBtn = document.getElementById('send-btn');
  const aigisWin = document.getElementById('aigis-window');
  const aigisToggle = document.getElementById('aigis-toggle');
  const closeBtn = document.getElementById('close-chat');
  let history: any[] = [];

  aigisToggle?.addEventListener('click', () => {
    aigisWin?.classList.toggle('opacity-0');
    aigisWin?.classList.toggle('pointer-events-none');
    aigisWin?.classList.toggle('translate-y-5');
    if (!aigisWin?.classList.contains('opacity-0')) input.focus();
  });

  closeBtn?.addEventListener('click', () => {
    aigisWin?.classList.add('opacity-0', 'pointer-events-none', 'translate-y-5');
  });

  async function handleChat() {
    const text = input.value.trim();
    if (!text) return;

    // 1. GUEST CHAT: Pakai guest-avatar.png
    display!.innerHTML += `
      <div class="flex items-start gap-3 self-end flex-row-reverse animate-fade-in">
        <div class="w-12 h-12 border-2 border-white skew-x-6 bg-[#001030] overflow-hidden shrink-0 shadow-[-4px_4px_0_rgba(255,255,255,0.2)]">
            <img src="/guest-avatar.png" onerror="this.src='/favicon.svg'" class="w-full h-full object-cover" />
        </div>
        <div class="bg-white text-black p-3 skew-x-6 border-l-4 border-gray-400 max-w-[240px] shadow-lg relative">
          <p class="-skew-x-6 text-[11px] font-bold leading-tight">${text}</p>
        </div>
      </div>`;
    
    input.value = "";
    display!.scrollTop = display!.scrollHeight;

    try {
        const res = await fetch('/api/aigis', {
          method: 'POST',
          body: JSON.stringify({ message: text, history }),
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();

        if (data.text) {
          history.push({ role: "user", parts: [{ text }] });
          history.push({ role: "model", parts: [{ text: data.text }] });

          const avatarPath = getAigisAvatar();
          // 2. AIGIS CHAT
          display!.innerHTML += `
            <div class="flex items-start gap-3 self-start animate-fade-in">
              <img src="${avatarPath}" onerror="this.src='/aigis-portrait.png'" class="w-12 h-12 border-2 border-cyan-400 -skew-x-6 bg-cyan-900 object-cover shrink-0 shadow-[4px_4px_0_rgba(0,240,255,0.3)]" />
              <div class="bg-[#001030]/90 text-white p-3 -skew-x-6 border-r-4 border-cyan-500 max-w-[240px] shadow-lg border border-cyan-500/20">
                <p class="skew-x-6 text-[11px] font-medium leading-relaxed">${data.text}</p>
              </div>
            </div>`;
        }
    } catch (e) {
        console.error("Chat Malfunction:", e);
    }
    display!.scrollTop = display!.scrollHeight;
  }

  sendBtn?.addEventListener('click', handleChat);
  input.addEventListener('keypress', (e) => e.key === 'Enter' && handleChat());
</script>

<style>
  #chat-display::-webkit-scrollbar { display: none; }
  .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px) scale(0.9); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
</style>