---
interface Props {
  lines: string[];
}

const { lines } = Astro.props;
---

<div id="dialogue-container" class="fixed bottom-4 md:bottom-10 left-0 w-full z-[100] px-2 md:px-20 hidden opacity-0 transition-all duration-500 pointer-events-none">
  <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center md:items-end gap-0 translate-y-10 transition-transform duration-700 ease-out" id="dialogue-box-wrapper">
    
    <div class="relative flex-shrink-0 w-32 h-32 md:w-72 md:h-72 z-10 -mb-6 md:mb-0 md:-mr-12 self-start md:self-auto ml-4 md:ml-0">
      <img 
        id="aigis-dynamic-portrait"
        src="/aigis-sees.png" 
        alt="Aigis Portrait" 
        class="w-full h-full object-contain filter drop-shadow-[5px_0_10px_rgba(0,0,0,0.5)] md:drop-shadow-[10px_0_20px_rgba(0,0,0,0.5)]" 
      />
    </div>

    <div class="relative flex-grow w-full md:w-auto pointer-events-auto cursor-pointer group">
      <div class="absolute -top-5 left-6 md:left-12 z-30">
        <div class="relative bg-blue-600 py-0.5 md:py-1 px-6 md:px-10 shadow-[3px_3px_0_rgba(0,0,0,0.4)]" 
             style="clip-path: polygon(0% 0%, 100% 20%, 85% 100%, 5% 85%);">
          <span class="text-sm md:text-lg font-black italic text-white uppercase tracking-[0.1em] md:tracking-[0.2em] font-mono">
            Aigis
          </span>
        </div>
      </div>

      <div class="relative">
        <div class="absolute inset-0 bg-blue-500/30 -skew-x-[4deg] md:-skew-x-[10deg] translate-x-1 md:translate-x-2 translate-y-1 md:translate-y-2"></div>
        <div class="relative bg-gradient-to-br from-blue-950 via-blue-900 to-black border-y-2 border-blue-400/60 py-5 md:py-8 px-6 md:px-20 -skew-x-[4deg] md:-skew-x-[10deg] shadow-[0_10px_30px_rgba(0,0,0,0.8)] min-h-[80px] md:min-h-[120px] flex items-center">
          <div class="skew-x-[4deg] md:skew-x-[10deg] w-full text-left">
            <p id="dialogue-text" class="text-white text-sm md:text-2xl font-bold leading-snug md:leading-relaxed tracking-wide drop-shadow-md"></p>
          </div>
          <div class="absolute bottom-2 md:bottom-4 right-4 md:right-6 animate-bounce">
            <div class="w-0 h-0 border-l-[6px] md:border-l-[8px] border-r-[6px] md:border-r-[8px] border-t-[10px] md:border-t-[14px] border-l-transparent border-r-transparent border-t-blue-300"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ lines }}>
  const textElement = document.getElementById('dialogue-text');
  const container = document.getElementById('dialogue-container');
  const wrapper = document.getElementById('dialogue-box-wrapper');
  const musicPlayer = document.getElementById('music-player-container');
  const portraitImg = document.getElementById('aigis-dynamic-portrait');

  let currentLine = 0;
  let currentChar = 0;
  let isTyping = false;

  function updateAigisPortrait() {
    const now = new Date();
    const hour = now.getHours();
    const day = now.getDay(); 

    let portraitPath = "/aigis-portrait.png"; 

    if (hour >= 0 && hour < 5) {
      portraitPath = "/Aigis-potrait.png";
    } else if (day === 6) {
      portraitPath = "/aigis-weekend.png";
    } else if (day === 0) {
      portraitPath = "/aigis-weekend2.png";
    } else if (day >= 1 && day <= 5 && hour >= 8 && hour < 17) {
      portraitPath = "/Aigis-uniform.png";
    }

    if (portraitImg) portraitImg.src = portraitPath;
  }

  function typeText() {
    if (currentLine >= lines.length) return;
    isTyping = true;
    const text = lines[currentLine];
    if (currentChar < text.length) {
      textElement.innerHTML += text.charAt(currentChar);
      currentChar++;
      setTimeout(typeText, 30);
    } else {
      isTyping = false;
    }
  }

  function nextLine() {
    if (isTyping) {
      currentChar = lines[currentLine].length;
      textElement.innerHTML = lines[currentLine];
      isTyping = false;
    } else {
      currentLine++;
      if (currentLine < lines.length) {
        textElement.innerHTML = '';
        currentChar = 0;
        typeText();
      } else {
        wrapper.classList.add('translate-y-10');
        container.classList.add('opacity-0');
        musicPlayer?.classList.remove('hide-on-chat'); 
        setTimeout(() => container.classList.add('hidden'), 600);
      }
    }
  }

  document.addEventListener('personaSummoned', () => {
    updateAigisPortrait();
    container.classList.remove('hidden');
    setTimeout(() => {
        wrapper.classList.remove('translate-y-10');
        container.classList.remove('opacity-0');
        container.classList.add('opacity-100');
        musicPlayer?.classList.add('hide-on-chat'); 
        typeText();
    }, 1200);
  });

  container.addEventListener('click', nextLine);
</script>