---
import "../styles/global.css";
import Bubbles from '../components/Bubbles.astro'; 
import MusicPlayer from '../components/MusicPlayer.astro';
import Navbar from '../components/Navbar.astro';
import { ViewTransitions } from 'astro:transitions';
import ProjectModal from "../components/ProjectModal.astro";

const { title, isVelvetRoom = false } = Astro.props;
---

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>{title}</title>
        <ViewTransitions />
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,400;0,600;0,700;0,900;1,700&display=swap" rel="stylesheet">
    </head>
    
    <body 
        data-page-type={isVelvetRoom ? "velvet" : "normal"}
        class="bg-[#002060] text-white font-['Exo_2'] overflow-x-hidden relative min-h-screen transition-all duration-[3000ms]"
    >
        <div id="normal-bg" class="fixed inset-0 z-[-10] transition-opacity duration-[3000ms] bg-[radial-gradient(circle_at_80%_0%,_#85F2FF_0%,_#0090F0_45%,_#001540_100%)]"></div>
        
        <div id="dark-hour-bg" class="fixed inset-0 z-[-9] opacity-0 transition-opacity duration-[3000ms] bg-cover bg-center bg-no-repeat pointer-events-none" style="background-image: url('/dark-hour.png');">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_20%,rgba(0,0,0,0.5)_100%)]"></div>
        </div>

        { !isVelvetRoom && (
            <Navbar />
            <MusicPlayer />
            <div id="bubbles-wrapper" class="transition-opacity duration-[2000ms]">
                <Bubbles />
            </div>
        )}
        
        <ProjectModal />

        <div id="base-vignette" class="fixed inset-0 pointer-events-none z-[-1] bg-[radial-gradient(circle_at_center,transparent_20%,#000515_120%)] opacity-20"></div>

        <div id="top" class="relative z-10">
            <slot />
        </div>

        <script>
            const updateTheme = () => {
                const hour = new Date().getHours();
                const body = document.body;
                const isVelvet = body.getAttribute('data-page-type') === 'velvet';
                const isDarkHour = hour >= 0 && hour < 5 && !isVelvet;

                const normalBg = document.getElementById('normal-bg');
                const darkHourBg = document.getElementById('dark-hour-bg');
                const baseVignette = document.getElementById('base-vignette');
                const bubbles = document.getElementById('bubbles-wrapper');

                if (isDarkHour) {
                    body.classList.add('dark-hour-active');
                    if (normalBg) normalBg.style.opacity = "0";
                    if (darkHourBg) darkHourBg.style.opacity = "1";
                    if (bubbles) bubbles.style.opacity = "0";
                } else {
                    body.classList.remove('dark-hour-active');
                    if (isVelvet) {
                        if (normalBg) normalBg.style.opacity = "0";
                        if (darkHourBg) darkHourBg.style.opacity = "0";
                        if (baseVignette) baseVignette.style.opacity = "0";
                        
                        const lobbyAudio = document.getElementById('bgm-audio') as HTMLAudioElement;
                        if (lobbyAudio) {
                            lobbyAudio.pause();
                            lobbyAudio.currentTime = 0;
                        }
                    } else {
                        if (normalBg) normalBg.style.opacity = "1";
                        if (darkHourBg) darkHourBg.style.opacity = "0";
                        if (bubbles) bubbles.style.opacity = "1";
                        if (baseVignette) baseVignette.style.opacity = "0.2";
                    }
                }
            };

            document.addEventListener('DOMContentLoaded', updateTheme);
            document.addEventListener('astro:after-swap', updateTheme);
        </script>
    </body>
</html>